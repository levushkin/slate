## Заказ

Заказ - оформленный покупателем у Клиента заказ, передаваемый Клиентом в Сервис для отправки покупателю. Характеризуется набором атрибутов, среди которых:

1. Информация о магазине и складе Клиента:
1. Список магазинов Клиента можно получить, вызвав GET /v1/shops в API.
1. Список складов Клиента можно получить, вызвав GET /v1/warehouses в API.
1. СД, которой заказ будет доставлен покупателю. Список СД, подключенных клиентом, можно получить, вызвав метод GET /v1/deliveries в API.
1. ВГХ заказа.
1. Стоимостные характеристики.
1. Покупатель, включая его основные характеристики (ФИО, контакты для связи, адрес).
1. Список товарных позиций.
1. Оффер, по которому заказ будет отправлен получателю.
1. Прочее.

В зависимости от выполняемого действия Сервис и Клиент могут обмениваться разным набором характеристик заказа.

### Создание заказа

<aside class="notice">
Для создания заказа необходимо вызвать метод POST /v1/orders в API, передав при этом информацию о заказе.
</aside>

Важно учитывать следующие особенности:

1. Оффер, по которому будет отправлен заказ:
  1. Определяется службой доставки и идентификатором тарифа в ней.
  1. Некоторые СД требуют указывать тариф, а некоторые - нет. Поэтому в общем случае мы рекомендуем указывать при создании заказа идентификатор тарифа от СД.
1. При создании заказа Клиент должен указать СД, выбранную для доставки заказа.
1. При создании заказа Клиент должен указать номер создаваемого заказа, присвоенный ему в информационной системе Клиента. Указанный номер заказа:
  1. Должен быть уникальным в пределах одного магазина Клиента. В случае, если Клиент попытается создать заказ с повторяющимся номером, Сервис не создаст новый заказ, а вернёт информацию о заказе, который был создан ранее.
  1. Может использоваться, например, в следующих ситуациях:
      1. Для устранения инцидентов, которые могут возникнуть в ходе интеграционного взаимодействия.
      1. Для печати ярлыков в ситуации, когда Клиент договорился с СД работать по своим номерам заказов.
1. В зависимости от выбранного типа доставки (courier, pickup, post) при создании заказа может потребоваться заполнение различных атрибутов:
  1. Тип «courier» означает курьерскую доставку. При указании типа доставки courier следует заполнить адрес в разделе о покупателе.
  1. Тип «pickup» означает доставку до ПВЗ. При указании типа доставки pickup адрес заполнять не нужно. Вместо него обязательно следует указать код ПВЗ. У Клиента есть 2 способа узнать код ПВЗ:
      1. Разместить на сайте своего ИМ виджет СД с выбором ПВЗ и получать информацию о коде ПВЗ из виджета.
      1. Получить список ПВЗ из Сервиса, вызвав метод GET /v1/pickuppoints в API, отфильтровать их по СД и выбрать из них тот, в который следует доставить заказ.
  1. Тип «post» означает доставку Почтой России. Важно учитывать, что этот тип доставки может быть указан тогда и только тогда, когда в качестве СД для доставки заказа выбрана Почта России. Т.е. если выбрать для отправки заказа другую СД, но указать тип доставки «post», то Сервис ответит ошибкой и не создаст заказ.
1. При создании заказа Клиент должен указать стоимостные характеристики, в числе которых:
  1. Стоимость доставки заказа. Эта стоимость Сервисом не используется, но является обязательной к заполнению, потому что большая часть СД требует заполнения этого поля.
  1. Предоплаченная часть заказа.
  1. Оценочная стоимость заказа, она же - объявленная ценность.
  1. Сумма, которую необходимо взять с покупателя перед выдачей заказа. Не может превышать объявленную ценность.
1. Номер заказа в системе складского оператора. В общем случае не требуется, но в некоторых ситуациях его заполнение обязательно. Если этот номер используется в вашем логистическом процессе, просто начните его передавать.
1. При осуществлении доставки Клиенту могут потребоваться дополнительные услуги (примерка, подъём груза, наложенный платёж и др.), которые он будет ожидать получить от СД. В этом случае клиент самостоятельно должен перечислить коды услуг. Сервис не ограничивает Клиента в перечислении. Такие услуги в API называются «сервисами», а их полный список можно получить, вызвав метод GET /services в API. 
1. При указании адреса покупателя Клиент может заполнить множество различных атрибутов, среди которых: код адреса в ФИАС, код адреса в КЛАДР, адрес одной строкой или адрес с разбивкой по нескольким полям (город, улица, дом и т.д.). Клиенту не следует заполнять каждое из этих полей, а нужно заполнить только одно из сочетаний:
  1. Почтовый индекс и адрес одной строкой в разбивке по атрибутам.
  1. Код ФИАС и адрес одной в разбивке по атрибутам.
  1. Код КЛАДР и адрес одной в разбивке по атрибутам.
  1. Адрес одной строкой.
1. Если Клиент заполнит несколько сочетаний адреса покупателя (например, почтовый индекс, код ФИАС и адрес одной строкой), то Сервис не сможет гарантировать.корректную передачу адреса в СД. В связи с этим мы настоятельно рекомендуем:
  1. Всегда явно указывать адрес отправителя.
  1. Не смешивать классификации адресов.
1. Для заказов, отправляемых Почтой России, необходимо указывать почтовый индекс. Если индекс не будет передан, то Сервис попытается узнать его по прочим переданным данным. Если этого не удастся сделать, то заказ не будет создан. По этой причине мы рекомендуем явно передавать почтовый индекс в тех случаях, когда требуется отправить заказ Почтой России.
1. ФИО покупателя. Причём Сервису достаточно знать только фамилию и имя. Обратите внимание на то, что при создании заказа составляющие ФИО передаются в отдельных полях. При этом технически возможна передача ФИО в одном поле, но в этом случае Сервис будет полагаться на службу верификации данных, которая разбивает строку на составляющие с определённой (не равной 100%) точностью. В связи с этим мы настоятельно рекомендуем указывать фамилию и имя в предусмотренных для этого полях запроса на создание заказа.
1. Кроме адреса, куда доставляется заказ, иногда может потребоваться узнать адрес, откуда он отправляется. Эта информация определяется по складу. Если у Клиента открывается новая локация отправления, то ему следует создать новый склад, после чего начать его указывать в заказах, которые отправляются из новой локации.
1. В заказе может быть перечислено несколько товарных позиций, причём:
  1. Для каждой из них может быть указан свой код ставки НДС. Полный список доступных для указания кодов ставки НДС можно получить, вызвав метод GET /v1/vats в API.
  1. Если не передать код ставки НДС, то Сервис принудительно подставит значение «НДС не облагается».
1. Сервис поддерживает возможность создания многоместного заказа, т.е. заказа, который по каким-то причинам не поместился в одной упаковке, но при этом должен быть доставлен покупателю единовременно. При этом важно учитывать, что:
  1. Не все СД поддерживают возможность отправки многоместных заказов. Прежде чем создавать такой заказ убедитесь, что СД может обеспечить такую возможность.
  1. В одном месте может быть перечислено несколько товарных позиций.
  1. Одна товарная позиция может быть размещена только в одном месте.
  1. Сервис не производит никаких валидаций, связанных с корректностью указания ВГХ в зависимости от добавленных в них товарных позиций и т.п.

### Редактирование заказа

<aside class="notice">
Для редактирования заказа необходимо вызвать метод PUT /v1/orders/{id} в API, передав при этом информацию о заказе полностью, т.е. должны быть перечислены все поля - как изменённые, так и оставленные без изменений.
</aside>

В заказе посредством API можно отредактировать любое поле, но только до момента добавления заказа в партию. После редактирования в ЛК Сервиса Клиент будет видеть заказ с отредактированными значениями полей, равно как и при запросе информации о заказе через API. Однако это не означает, что вся эта информация будет отражена в СД. Эта особенность вызвана тем, что не все СД позволяют редактировать заказ, а те, которые позволяют, имеют некоторые ограничения, которые в настоящий момент не валидируются API Сервиса. По этой причине и во избежание возникновения каких-либо проблем настоятельно рекомендуем не редактировать заказ, а удалять его и создавать новый.

### Удаление заказа

<aside class="notice">
Для удаления заказа необходимо вызвать метод DELETE /v1/orders/{id} в API.
</aside>

Заказ может быть удалён в любой момент, т.е. даже после добавления заказа в партию. После удаления заказ:
1. Перестаёт отображаться в ЛК.
1. Исключается из партии, если он уже был в неё добавлен.
1. Может продолжать отображаться в ЛК СД, т.к. не все СД позволяют удалять заказ, а те, которые позволяют, имеют некоторые ограничения, которые в настоящий момент не валидируются API Сервиса.

### Детали заказа

<aside class="notice">
Для получения информации о заказе необходимо вызвать метод GET /v1/orders/{id} в API.
</aside>

Несмотря на то, что Клиент при создании заказа передаёт в Сервис уникальный идентификатор заказа в собственной информационной системе, поиск заказов и получение информации по ним посредством обращения к API осуществляется по идентификатору, который был присвоен заказу Сервисом.

### История статусов заказа

<aside class="notice">
Для получения истории статусов заказа необходимо вызвать метод GET /v1/orders/{id}/statuses в API.
</aside>

У каждой службы доставки имеется свой собственный набор статусов. Иногда они пересекаются по названиям и кодам, а иногда - нет. Поэтому в Сервисе используется собственная статусная модель. Сервис самостоятельно осуществляет сопоставление статусов заказа в различных СД со своей статусной моделью. Для получения списка возможных статусов заказа необходимо вызвать метод GET /v1/statuses в API.

### Получение ярлыка

<aside class="notice">
Для получения ярлыка заказа необходимо вызвать метод GET /v1/orders/{id}/labels в API. В ответе на обращение к сервису будет передан PDF-файл в кодировке base64.
</aside>

Ярлык - печатная форма СД, которая формируется для каждого заказа и обычно содержит штрихкод и прочую информацию, по которой СД в автоматическом режиме может осуществить обработку заказа: отправку в нужном направлении, доставку до нужного склада и т.п.